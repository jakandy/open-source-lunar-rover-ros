<?xml version="1.0" encoding="utf-8"?>

<!-- 
#  
# Title:
#  Open Source Lunar Rover (OSLR) - Navcam model
#
# Author(s):
#   andyjak
#
# Version:
#   0.0.1, 08/2023
#
# Purpose:
#   Contains the navcam part of the model.
#
# Notes:
#   Include this file in the urdf file.
#   The geometry was generated using the urdf exporter for Solidworks.
#
# Test setup:
#   - ROS Noetic
#   - Ubuntu, 20.04 LTS
#   - Python 3.8.10
#
# References:
#   References are listed in the README.
#   Comments that include a [number] refers to the index in the reference list.
#
-->

<robot
  xmlns:xacro="http://ros.org/wiki/xacro"
  name="oslr_navcam">
  
  <!-- ********************************** PARAMETER VALUES ********************************** -->
  <xacro:property name="navcam_vertical_angle_lim_upper" value="${yaml_dict['navcam_vertical_angle_lim_upper']}" />
  <xacro:property name="navcam_vertical_angle_lim_lower" value="${yaml_dict['navcam_vertical_angle_lim_lower']}" />
  <xacro:property name="navcam_vertical_effort_lim" value="${yaml_dict['navcam_vertical_effort_lim']}" />
  <xacro:property name="navcam_vertical_velocity_lim" value="${yaml_dict['navcam_vertical_velocity_lim']}" />
  <xacro:property name="navcam_horiz_angle_lim_upper" value="${yaml_dict['navcam_horiz_angle_lim_upper']}" />
  <xacro:property name="navcam_horiz_angle_lim_lower" value="${yaml_dict['navcam_horiz_angle_lim_lower']}" />
  <xacro:property name="navcam_horiz_effort_lim" value="${yaml_dict['navcam_horiz_effort_lim']}" />
  <xacro:property name="navcam_horiz_velocity_lim" value="${yaml_dict['navcam_horiz_velocity_lim']}" />
  <xacro:property name="navcam_baseline" value="${yaml_dict['navcam_baseline']}" />
  <xacro:property name="navcam_update_rate" value="${yaml_dict['navcam_update_rate']}" />
  <xacro:property name="navcam_fov" value="${yaml_dict['navcam_fov']}" />
  <xacro:property name="navcam_image_width" value="${yaml_dict['navcam_image_width']}" />
  <xacro:property name="navcam_image_height" value="${yaml_dict['navcam_image_height']}" />
  <xacro:property name="navcam_clip_near" value="${yaml_dict['navcam_clip_near']}" />
  <xacro:property name="navcam_clip_far" value="${yaml_dict['navcam_clip_far']}" />  
  <xacro:property name="friction_coeff1_navcam_horiz" value="${yaml_dict['friction_coeff1_navcam_horiz']}" />
  <xacro:property name="friction_coeff2_navcam_horiz" value="${yaml_dict['friction_coeff2_navcam_horiz']}" />
  <xacro:property name="stiffness_navcam_horiz" value="${yaml_dict['stiffness_navcam_horiz']}" />
  <xacro:property name="damping_navcam_horiz" value="${yaml_dict['damping_navcam_horiz']}" />
  <xacro:property name="friction_coeff1_navcam_vertical" value="${yaml_dict['friction_coeff1_navcam_vertical']}" />
  <xacro:property name="friction_coeff2_navcam_vertical" value="${yaml_dict['friction_coeff2_navcam_vertical']}" />
  <xacro:property name="stiffness_navcam_vertical" value="${yaml_dict['stiffness_navcam_vertical']}" />
  <xacro:property name="damping_navcam_vertical" value="${yaml_dict['damping_navcam_vertical']}" />
  
  <!-- ********************************** GEOMETRY ********************************** -->
  <link
    name="navcam_horiz">
    <inertial>
      <origin
        xyz="1.4055E-05 -0.00016527 0.0064297"
        rpy="0 0 0" />
      <mass
        value="0.10756" />
      <inertia
        ixx="3.8547E-05"
        ixy="-2.1844E-09"
        ixz="3.861E-11"
        iyy="1.7293E-05"
        iyz="-5.8055E-07"
        izz="3.6809E-05" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_horiz.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.89804 0.91765 0.92941 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_horiz.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="navcam_horiz_joint"
    type="revolute">
    <origin
      xyz="-0.0594359999999995 0 0.141849999878"
      rpy="0 0 0" />
    <parent
      link="base_link" />
    <child
      link="navcam_horiz" />
    <axis
      xyz="0 0 1" />
    <limit
      lower="${navcam_horiz_angle_lim_lower}"
      upper="${navcam_horiz_angle_lim_upper}"
      effort="${navcam_horiz_effort_lim}"
      velocity="${navcam_horiz_velocity_lim}" />
  </joint>
  <link
    name="navcam_vertical">
    <inertial>
      <origin
        xyz="0.003374 0.029259 -0.038925"
        rpy="0 0 0" />
      <mass
        value="0.11738" />
      <inertia
        ixx="0.00011323"
        ixy="-2.4644E-07"
        ixz="-2.1164E-10"
        iyy="0.00010434"
        iyz="-4.0911E-08"
        izz="1.246E-05" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_vertical.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.52941 0.54902 0.54902 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_vertical.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="navcam_vertical_joint"
    type="revolute">
    <origin
      xyz="0 -0.041675 0.019896"
      rpy="1.5708 0 0" />
    <parent
      link="navcam_horiz" />
    <child
      link="navcam_vertical" />
    <axis
      xyz="0 0 1" />
    <limit
      lower="${navcam_vertical_angle_lim_lower}"
      upper="${navcam_vertical_angle_lim_upper}"
      effort="${navcam_vertical_effort_lim}"
      velocity="${navcam_vertical_velocity_lim}" />
  </joint>
  <link
    name="navcam_eye_left">
    <inertial>
      <origin
        xyz="-7.2638E-07 -8.2672E-07 -0.0052173"
        rpy="0 0 0" />
      <mass
        value="0.0010272" />
      <inertia
        ixx="2.8574E-08"
        ixy="-5.5385E-12"
        ixz="-4.1306E-12"
        iyy="2.8583E-08"
        iyz="1.274E-12"
        izz="2.5264E-08" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_eye_left.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.79216 0.81961 0.93333 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_eye_left.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="navcam_eye_left_joint"
    type="fixed">
    <origin
      xyz="0.019244 0.034892 -0.081675"
      rpy="0 1.5708 0" />
    <parent
      link="navcam_vertical" />
    <child
      link="navcam_eye_left" />
    <axis
      xyz="0 0 0" />
  </joint>
  <link
    name="navcam_eye_right">
    <inertial>
      <origin
        xyz="-6.3011E-07 -8.8689E-07 -0.0052173"
        rpy="0 0 0" />
      <mass
        value="0.0010272" />
      <inertia
        ixx="2.8576E-08"
        ixy="-6.4052E-12"
        ixz="-4.5471E-12"
        iyy="2.8581E-08"
        iyz="8.4062E-13"
        izz="2.5264E-08" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_eye_right.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.79216 0.81961 0.93333 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://oslr_description/models/oslr/meshes/navcam_eye_right.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="navcam_eye_right_joint"
    type="fixed">
    <origin
      xyz="0.019244 0.034892 -0.001675"
      rpy="0 1.5708 0" />
    <parent
      link="navcam_vertical" />
    <child
      link="navcam_eye_right" />
    <axis
      xyz="0 0 0" />
  </joint>

  <!-- ********************************** GAZEBO PROPERTIES ********************************** -->
  <gazebo reference="navcam_horiz">
      <mu1>${friction_coeff1_navcam_horiz}</mu1>
      <mu2>${friction_coeff2_navcam_horiz}</mu2>
      <kp>${stiffness_navcam_horiz}</kp>
      <kd>${damping_navcam_horiz}</kd>

      <!--
        Turn off self-collision, to avoid strange behaviour when steering camera
      -->
      <selfCollide>0</selfCollide>
      
      <material>Gazebo/Grey</material>
  </gazebo>

  <gazebo reference="navcam_vertical">
      <mu1>${friction_coeff1_navcam_vertical}</mu1>
      <mu2>${friction_coeff2_navcam_vertical}</mu2>
      <kp>${stiffness_navcam_vertical}</kp>
      <kd>${damping_navcam_vertical}</kd>

      <!--
        Turn off gravity for the vertical navcam link, otherwise it will accelerate
        towards the ground when going from angle 0 to pi/2 which is not realistic behaviour.
      -->
      <gravity>0</gravity>

      <!--
        Turn off self-collision, to avoid strange behaviour when steering camera
      -->
      <selfCollide>0</selfCollide>

      <material>Gazebo/Grey</material>
  </gazebo>

  <!-- ********************************** GAZEBO PLUGIN FOR CAMERA ********************************** -->
  <gazebo reference="navcam_eye_left">
    <sensor type="multicamera" name="navcam">
      <update_rate>${navcam_update_rate}</update_rate>

      <camera name="left">
        <!-- 
          ROS Standard Coordinates | Camera coordinates
          +x                       | +z
          +y                       | -x
          +z                       | -y
        -->
        <pose>0 0 0 0 ${-pi/2} ${-pi/2}</pose>
        <horizontal_fov>${navcam_fov}</horizontal_fov>
        <image>
          <width>${navcam_image_width}</width>
          <height>${navcam_image_height}</height>
          <format>R8G8B8</format>
        </image>
        <clip>
          <near>${navcam_clip_near}</near>
          <far>${navcam_clip_far}</far>
        </clip>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.0</stddev>
        </noise>
      </camera>

      <camera name="right">
        <pose>${-navcam_baseline} 0 0 0 ${-pi/2} ${-pi/2}</pose>
        <horizontal_fov>${navcam_fov}</horizontal_fov>
        <image>
          <width>${navcam_image_width}</width>
          <height>${navcam_image_height}</height>
          <format>R8G8B8</format>
        </image>
        <clip>
          <near>${navcam_clip_near}</near>
          <far>${navcam_clip_far}</far>
        </clip>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.0</stddev>
        </noise>
      </camera>
      
      <plugin name="stereo_camera_controller" filename="libgazebo_ros_multicamera.so">
        <alwaysOn>true</alwaysOn>
        <updateRate>0.0</updateRate>
        <cameraName>oslr/navcam</cameraName>
        <imageTopicName>image_raw</imageTopicName>
        <cameraInfoTopicName>camera_info</cameraInfoTopicName>
        <frameName>navcam_eye_left</frameName>
        <hackBaseline>${navcam_baseline}</hackBaseline>
        <distortionK1>0.0</distortionK1>
        <distortionK2>0.0</distortionK2>
        <distortionK3>0.0</distortionK3>
        <distortionT1>0.0</distortionT1>
        <distortionT2>0.0</distortionT2>
      </plugin>
    </sensor>
  </gazebo>

  <!-- ********************************** TRANSMISSIONS ********************************** -->
  <transmission name="navcam_horiz_trans">
    <type>transmission_interface/SimpleTransmission</type>
    <actuator name="navcam_horiz_motor">
      <mechanicalReduction>189</mechanicalReduction>
    </actuator>
    <joint name="navcam_horiz_joint">
      <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
    </joint>
  </transmission>

  <transmission name="navcam_vertical_trans">
    <type>transmission_interface/SimpleTransmission</type>
    <actuator name="navcam_vertical_motor">
      <mechanicalReduction>189</mechanicalReduction>
    </actuator>
    <joint name="navcam_vertical_joint">
      <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
    </joint>
  </transmission>

</robot>
